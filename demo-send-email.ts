#!/usr/bin/env node

import { EmailReporter } from './src/support/EmailReporter';
import { TestResultsParser } from './src/support/TestResultsParser';
import * as dotenv from 'dotenv';

// Load environment variables
dotenv.config();

/**
 * Demo email sending with alternative SMTP providers
 */
async function sendDemoEmail() {
  console.log('ðŸ“§ ParaBank Demo Email Test');
  console.log('===========================');
  
  // Use a demo/test SMTP service for demonstration
  const demoEmailConfig = {
    host: 'smtp.ethereal.email', // Free test SMTP service
    port: 587,
    secure: false,
    auth: {
      user: 'ethereal.user@ethereal.email',
      pass: 'ethereal.pass'
    }
  };
  
  console.log('ðŸ”§ Using Ethereal Email (demo service) for testing...');
  console.log('ðŸ“ This will generate a preview URL instead of real sending');
  
  try {
    // Create realistic test results
    const testResults = {
      totalScenarios: 152,
      passedScenarios: 150,
      failedScenarios: 2,
      skippedScenarios: 0,
      executionTime: '5m 47s',
      successRate: 98.68,
      timestamp: new Date().toLocaleString('en-US', {
        timeZone: 'Europe/Moscow',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }),
      environment: 'demo-production',
      reportUrls: {
        allure: 'file:///c:/playwright/ParabankDemo/reports/allure-report/index.html',
        cucumber: 'file:///c:/playwright/ParabankDemo/reports/cucumber-report.html',
        playwright: 'file:///c:/playwright/ParabankDemo/reports/playwright-report/index.html'
      }
    };
    
    console.log('\nðŸ“Š Test Results Summary:');
    console.log(`   - Success Rate: ${testResults.successRate}%`);
    console.log(`   - Total Tests: ${testResults.totalScenarios}`);
    console.log(`   - Duration: ${testResults.executionTime}`);
    console.log(`   - Recipient: vmurashev@gmail.com`);
    
    // Generate and save email preview locally
    const emailReporter = new EmailReporter();
    const htmlContent = emailReporter.generateHTMLReport(testResults);
    
    const fs = require('fs');
    const path = require('path');
    
    // Save HTML preview
    const previewPath = path.join(process.cwd(), 'reports', 'demo-email-sent.html');
    fs.writeFileSync(previewPath, htmlContent);
    
    console.log('\nâœ… Demo Email Generated Successfully!');
    console.log(`ðŸ“„ Email preview saved: ${previewPath}`);
    console.log(`ðŸŒ Open in browser: file:///${previewPath.replace(/\\/g, '/')}`);
    
    // Also generate text summary
    const textSummary = `
ðŸ“§ ParaBank Test Results - Demo Email
=====================================

From: ParaBank Test System
To: vmurashev@gmail.com
Subject: âœ… ParaBank Nightly Tests - ${testResults.successRate}% Success Rate (${testResults.passedScenarios}/${testResults.totalScenarios})

ðŸ“Š Executive Summary:
- Success Rate: ${testResults.successRate}%
- Total Scenarios: ${testResults.totalScenarios}
- Passed: ${testResults.passedScenarios} âœ…
- Failed: ${testResults.failedScenarios} âŒ
- Execution Time: ${testResults.executionTime}
- Environment: ${testResults.environment}
- Timestamp: ${testResults.timestamp}

ðŸ“ˆ Performance Analysis:
ðŸŽ‰ EXCELLENT: Tests performing well! Application is stable and ready for deployment.

ðŸ“„ Available Reports:
- ðŸ“Š Allure Report: Interactive dashboard with detailed analytics
- ðŸŽ­ Playwright Report: Cross-browser test results
- ðŸ¥’ Cucumber Report: BDD scenario breakdown

ðŸ”— Report Links (in HTML email):
${Object.entries(testResults.reportUrls).map(([type, url]) => `- ${type.toUpperCase()}: ${url}`).join('\n')}

---
Generated by ParaBank Unified Test Framework v3.0
This is an automated email. For questions, contact the QA team.
`;
    
    const textPath = path.join(process.cwd(), 'reports', 'demo-email-content.txt');
    fs.writeFileSync(textPath, textSummary);
    
    console.log(`ðŸ“ Text version saved: ${textPath}`);
    
    console.log('\nðŸŽ¯ What this email contains:');
    console.log('============================');
    console.log('âœ… Professional HTML design with ParaBank branding');
    console.log('âœ… Executive summary with color-coded status');
    console.log('âœ… Detailed test statistics table');
    console.log('âœ… Performance analysis with recommendations');
    console.log('âœ… Working links to all report types');
    console.log('âœ… Mobile-responsive email layout');
    console.log('âœ… Automatic attachment handling');
    
    console.log('\nðŸš€ For Real Email Sending:');
    console.log('==========================');
    console.log('1. Get Gmail App Password from Google Account settings');
    console.log('2. Update .env file with real credentials:');
    console.log('   EMAIL_USER=your-email@gmail.com');
    console.log('   EMAIL_PASS=your-16-char-app-password');
    console.log('3. Run: npm run email:test');
    console.log('4. Email will be delivered to: vmurashev@gmail.com');
    
    return previewPath;
    
  } catch (error: any) {
    console.error('\nâŒ Demo email generation failed:', error.message);
    throw error;
  }
}

// Run the demo
sendDemoEmail().then((previewPath) => {
  console.log('\nâœ¨ Demo completed successfully!');
  console.log(`ðŸ”— Open the preview file to see exactly what vmurashev@gmail.com would receive.`);
  
  // Try to open the file in the default browser
  const { exec } = require('child_process');
  exec(`start "" "${previewPath}"`, (error: any) => {
    if (!error) {
      console.log('ðŸŒ Email preview opened in browser!');
    }
  });
  
}).catch((error) => {
  console.error('ðŸ’¥ Demo failed:', error.message);
  process.exit(1);
});
